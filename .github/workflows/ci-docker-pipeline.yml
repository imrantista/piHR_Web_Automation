name: CI_PIHR-docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e-docker:
    runs-on: ubuntu-latest
    env:
      # Set ENV to target_env if provided, otherwise default to PIHR_PROD
      ENV: ${{ github.event.inputs.target_env != null && github.event.inputs.target_env || 'PIHR_PROD' }}
      PROJECT_ID: docker
      REPORT_ID: ${{ github.run_number }}-${{ github.run_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print effective ENV
        run: echo "Effective ENV: $ENV"

      - name: Validate Variables and Secrets
        env:
          BASE_URL_PIHR_PROD: ${{ vars.BASE_URL_PIHR_PROD }}
          BASE_URL_PIHR_QA: ${{ vars.BASE_URL_PIHR_QA }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          EMPLOYEE_EMAIL: ${{ secrets.EMPLOYEE_EMAIL }}
          EMPLOYEE_PASSWORD: ${{ secrets.EMPLOYEE_PASSWORD }}
          SUPERVISOR_EMAIL: ${{ secrets.SUPERVISOR_EMAIL }}
          SUPERVISOR_PASSWORD: ${{ secrets.SUPERVISOR_PASSWORD }}
        run: |
          echo "Checking required Variables & Secrets..."
          MISSING=0
          for var in BASE_URL_PIHR_PROD ADMIN_EMAIL ADMIN_PASSWORD EMPLOYEE_EMAIL EMPLOYEE_PASSWORD SUPERVISOR_EMAIL SUPERVISOR_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "❌ Missing $var"
              MISSING=1
            else
              echo "✅ $var found"
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "Setup missing. See GITHUB_ACTIONS_SETUP.md"
            exit 1
          fi

      - name: Generate .env for tests
        env:
          BASE_URL_PIHR_PROD: ${{ vars.BASE_URL_PIHR_PROD }}
          BASE_URL_PIHR_QA: ${{ vars.BASE_URL_PIHR_QA }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          EMPLOYEE_EMAIL: ${{ secrets.EMPLOYEE_EMAIL }}
          EMPLOYEE_PASSWORD: ${{ secrets.EMPLOYEE_PASSWORD }}
          SUPERVISOR_EMAIL: ${{ secrets.SUPERVISOR_EMAIL }}
          SUPERVISOR_PASSWORD: ${{ secrets.SUPERVISOR_PASSWORD }}
        run: |
          cat <<EOF > .env
          BASE_URL_PIHR_PROD=${BASE_URL_PIHR_PROD}
          BASE_URL_PIHR_QA=${BASE_URL_PIHR_QA}
          ADMIN_EMAIL=${ADMIN_EMAIL}
          ADMIN_PASSWORD=${ADMIN_PASSWORD}
          EMPLOYEE_EMAIL=${EMPLOYEE_EMAIL}
          EMPLOYEE_PASSWORD=${EMPLOYEE_PASSWORD}
          SUPERVISOR_EMAIL=${SUPERVISOR_EMAIL}
          SUPERVISOR_PASSWORD=${SUPERVISOR_PASSWORD}
          ENV=${ENV}
          EOF
          echo "----- .env -----"
          grep 'BASE_URL\|ENV' .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build e2e image
        run: docker compose -f docker-compose.yml build e2e

      - name: Run tests in Docker
        run: |
          rm -rf allure-results allure-report || true
          mkdir -p allure-results allure-report
          ENV="${ENV}" docker compose run --rm e2e

      - name: Set up Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Allure CLI
        run: |
          curl -L -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          echo "/opt/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Generate Allure Report
        run: |
          allure generate allure-results --clean -o allure-report/projects/${REPORT_ID}

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Allure Report to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report/projects/${REPORT_ID}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report/projects/${REPORT_ID}
          destination_dir: projects/${REPORT_ID}
          keep_files: true

      - name: Send Email with Allure Report Link
        run: |
          REPORT_URL="https://github.com/${{ github.repository }}/projects/${REPORT_ID}"
          echo "Your PIHR Automation Test Report is ready: $REPORT_URL" | mailx -s "PIHR Automation Test Report" mostafa.imran@vivasoftltd.com
