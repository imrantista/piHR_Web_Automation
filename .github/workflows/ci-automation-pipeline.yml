name: CI_PIHR

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Target environment"
        required: true
        default: "PIHR_PROD"
        type: choice
        options: [PIHR_PROD, PIHR_QA, PIHR_DEV]
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ENV: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'PIHR_PROD' || github.event.inputs.target_env }}
      PROJECT_ID: ci
      REPORT_ID: ${{ github.run_number }}-${{ github.run_id }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup NodeJS with npm cache
      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Cache & install Playwright browsers
      - name: Cache Playwright Browsers
        id: cache-pw
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: pw-browsers-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: pw-browsers-${{ runner.os }}-

      - name: Install Playwright Browsers
        if: steps.cache-pw.outputs.cache-hit != 'true'
        run: npx playwright install

      # 5Ô∏è‚É£ Cache & install Allure CLI
      - name: Cache Allure CLI
        id: cache-allure
        uses: actions/cache@v3
        with:
          path: /opt/allure-2.27.0
          key: allure-${{ runner.os }}-2.27.0
          restore-keys: allure-${{ runner.os }}-

      - name: Install Allure CLI
        if: steps.cache-allure.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y curl unzip
          curl -L -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          echo "/opt/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Setup Allure from cache
        if: steps.cache-allure.outputs.cache-hit == 'true'
        run: echo "/opt/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Verify Allure
        run: allure --version

      # 6Ô∏è‚É£ Clear previous results
      - name: Clear Previous Allure Results
        run: |
          rm -rf allure-results allure-report allure-history || true
          mkdir -p allure-results allure-report allure-history

      # 7Ô∏è‚É£ Generate .env for tests
      - name: Generate .env
        run: |
          set -e
          echo "BASE_URL_PIHR_PROD=${{ vars.BASE_URL_PIHR_PROD }}" >> .env
          echo "BASE_URL_PIHR_QA=${{ vars.BASE_URL_PIHR_QA }}" >> .env
          echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> .env
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
          echo "EMPLOYEE_ADMIN_EMAIL=${{ secrets.EMPLOYEE_ADMIN_EMAIL }}" >> .env
          echo "EMPLOYEE_ADMIN_PASSWORD=${{ secrets.EMPLOYEE_ADMIN_PASSWORD }}" >> .env
          echo "EMPLOYEE_EMAIL=${{ secrets.EMPLOYEE_EMAIL }}" >> .env
          echo "EMPLOYEE_PASSWORD=${{ secrets.EMPLOYEE_PASSWORD }}" >> .env
          echo "DEACTIVATED_ADMIN=${{ secrets.DEACTIVATED_ADMIN }}" >> .env
          echo "DEACTIVATED_PASSWORD=${{ secrets.DEACTIVATED_PASSWORD }}" >> .env
          echo "SUPERVISOR_EMAIL=${{ secrets.SUPERVISOR_EMAIL }}" >> .env
          echo "SUPERVISOR_PASSWORD=${{ secrets.SUPERVISOR_PASSWORD }}" >> .env
          echo "ENV=${ENV}" >> .env
          echo "‚úÖ .env generated"

      # 8Ô∏è‚É£ Run Playwright tests
      - name: Run Playwright Tests
        run: npx cross-env ENV=${ENV} playwright test --grep @Business/Functional

      # 9Ô∏è‚É£ Upload artifacts even if tests fail
      - name: Upload Global Setup Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: global-setup-artifacts
          path: artifacts/global-setup/**/*
          if-no-files-found: ignore  

      # üîü Handle Allure history for Pages
      - name: Check gh-pages existence
        id: has-ghpages
        run: |
          if git ls-remote --heads "https://github.com/${{ github.repository }}.git" gh-pages | grep gh-pages >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout gh-pages (history restore)
        if: steps.has-ghpages.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          persist-credentials: false

      - name: Restore Allure history
        run: |
          if [ -d gh-pages/projects/${PROJECT_ID}/history ]; then
            rm -rf allure-history
            mkdir -p allure-history
            cp -r gh-pages/projects/${PROJECT_ID}/history/* allure-history
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Generate Allure Report
      - name: Generate Allure Report
        run: allure generate allure-results --clean -o allure-report/projects/${REPORT_ID}

      - name: Merge Allure history
        run: |
          mkdir -p allure-report/projects/${REPORT_ID}/history
          cp -r allure-results/history/* allure-report/projects/${REPORT_ID}/history/ || true
          touch allure-report/projects/${REPORT_ID}/.nojekyll

      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy Allure Report to GitHub Pages
      - name: Deploy Allure Report
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: projects/${REPORT_ID}
          keep_files: true

      # 1Ô∏è‚É£3Ô∏è‚É£ Add clickable report link to summary
      - name: Add Report Link to Summary
        run: |
          echo "## PIHR Automation Test Report" >> $GITHUB_STEP_SUMMARY
          echo "[Click here to view report](https://imrantista.github.io/piHR_Web_Automation/projects/${REPORT_ID}/)" >> $GITHUB_STEP_SUMMARY

      # 1Ô∏è‚É£4Ô∏è‚É£ Send Email
      - name: Send Email with Allure Report
        run: |
          REPORT_URL="https://imrantista.github.io/piHR_Web_Automation/projects/${REPORT_ID}/"
          echo "PIHR Automation Test Report (CI)
View full report: $REPORT_URL" \
          | mailx -s "PIHR Automation Test Report Summary" mostafa.imran@vivasoftltd.com
